

@model Tuple<ServiceDashBoard1.Models.EmployeeRegistration, List<ServiceDashBoard1.Models.EmployeeRegistration>>

@{
    ViewData["Title"] = "Employee Registration";
}

<div>
    @Html.ActionLink("Back to AdminDashBoard", "Index", "ComplaintRegistrations", null, new { @class = "btn btn-primary m-3" })
</div>


<div class="container my-3">
    <div class="row">
        <!-- Registration Form -->
        <div class="col-md-6 col-sm-12">
            <div class="card mt-3">
                <div class="card-header text-center">
                    <h3>Customer Registration</h3>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="EmployeeRegistration" asp-controller="Users">
                        <div class="mb-3">
                            <label for="CompanyName" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="CompanyName" name="CompanyName" value="@Model.Item1?.CompanyName" />
                            <span asp-validation-for="Item1.CompanyName" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label for="CompanyAddress" class="form-label">Company Address</label>
                            <input type="text" class="form-control" id="CompanyAddress" name="CompanyAddress" value="@Model.Item1?.CompanyAddress" />
                            <span asp-validation-for="Item1.CompanyAddress" class="text-danger"></span>
                        </div>

                         <div class="mb-3">
                    <label asp-for="Item1.Pincode" class="form-label"></label>
                            <input asp-for="Item1.Pincode" class="form-control" id="Pincode" name="Pincode" value="@Model.Item1?.Pincode" />
                     <span asp-validation-for="Item1.Pincode" class="text-danger"></span>
                      </div> 

                        <div class="mb-3">
                      <label asp-for="Item1.ContactPersonName" class="form-label"></label>
                            <input asp-for="Item1.ContactPersonName" class="form-control" id="ContactPersonName" name="ContactPersonName" value="@Model.Item1?.ContactPersonName" />
                     <span asp-validation-for="Item1.ContactPersonName" class="text-danger"></span>
</div> 

                        <div class="mb-3">
                            <label for="Email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="Email" name="Email" value="@Model.Item1?.Email" />
                            <span asp-validation-for="Item1.Email" class="text-danger"></span>
                            <span id="EmailError" class="text-danger"></span> <!-- Added for JS -->

                        </div>

                        <div class="mb-3">
                            <label for="PhoneNo" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="PhoneNo" name="PhoneNo" value="@Model.Item1?.PhoneNo" />
                            <span asp-validation-for="Item1.PhoneNo" class="text-danger"></span>
                            <span id="PhoneNoError" class="text-danger"></span> <!-- Added for JS -->

                        </div>

                     

                        <div class="mb-3">
                            <label for="Username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="Username" name="Username" value="@Model.Item1?.Username" readonly/>
                            <span asp-validation-for="Item1.Username" class="text-danger"></span>
                            <span id="EmailError" class="text-danger"></span> <!-- Added for JS -->

                        </div>

                        <div class="mb-3">
                            <label for="Password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="Password" name="Password" />
                            <span asp-validation-for="Item1.Password" class="text-danger"></span>
                        </div>
                        <div class="row">
                            <!-- Machine Serial No -->
                            <div class="col-md-6 mb-3">
                                <label for="MachineSerialNo" class="form-label">Machine Serial No</label>
                                <input type="text" class="form-control" id="MachineSerialNo" name="MachineSerialNo" value="@Model.Item1?.MachineSerialNo" />
                                <span asp-validation-for="Item1.MachineSerialNo" class="text-danger"></span>
                            </div>

                            <!-- Machine Type -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="Item1.MachineType" class="form-label"></label>
                                <select asp-for="Item1.MachineType" class="form-control" id="MachineType" name="MachineType">
                                    <option value="">-- Please select --</option>
                                    <option>Ecat Sheet Cutting</option>
                                    <option>Beckhoff Sheet Cutting</option>
                                    <option>Fanuc Sheet Cutting</option>
                                    <option>Chuck 3 Tube Cutting</option>
                                    <option>Chuck 2 Tube Cutting</option>
                                    <option>Sheet Tube Cutting Machine</option>
                                    <option>Welding Machine</option>
                                    <option>Marking Machine</option>
                                    <option>Laser Cutting</option>
                                    <option>Engraver Machine</option>
                                    <option>Router Machine</option>
                                    <option>Robot Cutting Welding</option>
                                    <option>SPM</option>
                                    <option>Other</option>
                                </select>
                                <span asp-validation-for="Item1.MachineType" class="text-danger"></span>
                            </div>
                        </div>


                        <div class="mb-3">
                            <label for="isActive" class="form-label">Status</label>
                            <select class="form-control" id="isActive" name="isActive" value="@Model.Item1?.isActive">
                                <option value="">Select</option>
                                <option value="Active">Active</option>
                                <option value="De-Active">De-Active</option>
                            </select>
                            <span asp-validation-for="Item1.isActive" class="text-danger"></span>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Register</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Existing Employees Table -->
        <div class="col-md-6 col-sm-12">
            <div class="card mt-3">
                <div class="card-header text-center">
                    <h3>Existing Customers</h3>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-bordered table-striped m-0">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>Company Name</th>
                                    <th>Company Address</th>
                                    <th>Pincode</th>
                                    <th>Contact Person</th>
                                    <th>Phone No</th>
                                    <th>Email</th>
                                    <th>Username</th>
                                    <th>Machine Serial No</th>
                                    <th>Machine Type</th>
                                    <th>Status</th>
                                    <th>Created Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var emp in Model.Item2)
                                {
                                    <tr>
                                        <td>@emp.CompanyName</td>
                                        <td>@emp.CompanyAddress</td>
                                        <td>@emp.Pincode</td>
                                        <td>@emp.ContactPersonName</td>
                                        <td>@emp.PhoneNo</td>
                                        <td>@emp.Email</td>
                                        <td>@emp.Username</td>
                                         <td>@emp.MachineSerialNo</td>
                                        <td>@emp.MachineType</td>
                                        <td>@emp.isActive</td>
                                        <td>@(emp.CreatedDate?.ToString("dd-MM-yyyy") ?? "")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mt-3 text-center px-3">
                <button id="toggleStatusBtn" class="btn btn-secondary w-50 mx-auto">
                    Active/De-Active Existing Users
                </button>
                <div id="statusSection" style="display:none;" class="mt-2 mx-auto">
                    <!-- Username input -->
                    <input type="text"
                           id="usernameInput"
                           class="form-control mx-auto mb-2"
                           style="max-width: 300px; width: 90%;"
                           placeholder="Enter username" />

                    <!-- Status display & edit -->
                    <select id="statusSelect" class="form-control mx-auto mb-2" style="max-width: 300px; width: 90%;">
                        <option value="">-- Select Status --</option>
                        <option value="Active">Active</option>
                        <option value="DeActive">DeActive</option>
                    </select>

                    <!-- Save button -->
                    <button id="saveStatusBtn" class="btn btn-primary w-50 mx-auto">
                        Save
                    </button>

                    <div id="message" class="mt-2"></div>
                </div>
            </div>
        </div>
 </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>



        $(document).ready(function () {

              function generateUsername() {
        const company = $("#CompanyName").val().trim().toLowerCase().replace(/\s+/g, '');
        const contact = $("#ContactPersonName").val().trim().toLowerCase();

        if (!company || !contact) return;

        const initials = contact.split(' ').map(w => w[0]).join('').substring(0, 2);
        const companyPart = company.substring(0, 3);
        const randomNum = Math.floor(100 + Math.random() * 900); // Random 3-digit

        const username = (companyPart + initials + randomNum).substring(0, 8);

        $.post("/Users/CheckExistingCustomer", { field: "Username", value: username }, function (data) {
            if (data.exists) {
                generateUsername(); // Try again if not unique
            } else {
                $("#Username").val(username);
            }
        });
    }

    $("#CompanyName, #ContactPersonName").on("input", generateUsername);


            $("#Email, #PhoneNo,#CompanyAddress,#Password,#CustomerName,#Username").on("input", function () {
                var field = $(this).attr("id");
                $("span[data-valmsg-for='" + field + "']").text("");
                $("#" + field + "Error").text("").hide();
            });

            $("#PhoneNo").on("input", function () {
                var value = $(this).val().trim();
                var errorSpan = $("#PhoneNoError");
                value = value.replace(/^0+/, '');
                $(this).val(value);

                if (!/^\d{10}$/.test(value)) {
                    errorSpan.text("Phone number must be exactly 10 digits").css("color", "red").show();
                } else {
                    errorSpan.text("").hide();
                }
            });

            $("#Email, #PhoneNo, #Username").on("blur", function () {
                var field = $(this).attr("id");
                var value = $(this).val().trim();
                var errorSpan = $("#" + field + "Error");

                if (value === "") {
                    errorSpan.text("").hide();
                    return;
                }

                $.post("/Users/CheckExistingCustomer", { field: field, value: value }, function (data) {
                    if (data.exists) {
                        errorSpan.text(field + " already exists! Please choose another.").css("color", "red").show();
                    } else {
                        errorSpan.text("").hide();
                    }
                }).fail(function () {
                    errorSpan.text("Error checking " + field).css("color", "red").show();
                });
            });
        });






                 $(document).ready(function () {
        $("#toggleStatusBtn").click(function () {
            $("#statusSection").toggle();
            $("#usernameInput").val("");
            $("#statusSelect").val("");
            $("#message").text("");
            $("#usernameInput").focus();
        });

        let inputTimeout; // declare globally
        // On username input blur (or you can change event to 'change' or a button)
        $("#usernameInput").on('input', function () {
             clearTimeout(inputTimeout); // reset timer on every keystroke
             
             const self = this; // ✅ save the correct reference
             inputTimeout = setTimeout(function () {

            var username = $(self).val().trim();
            console.log(username);
            if(username){
                // Call server to get status for username
                $.ajax(
                    {
                    url: '@Url.Action("GetUserStatusCustomers", "Users")', // Update controller/action as needed
                    type: 'GET',
                    data: { username: username },

                    success: function(response) {
                        console.log(response.status);
                        if(response.status){
                          console.log(username);
                          console.log(response.status);

                            $("#statusSelect").val(response.status);
                            $("#message").text("");

                        } else {
                            $("#statusSelect").val("");
                            $("#message").text("User not found or error fetching status").css({
             "color": "white",
             "font-weight": "bold",
             "background-color": "Red", // or dark background for contrast
             "padding": "8px",
             "border-radius": "5px"
         });
          resetStatusForm();
                        }
                    },
                    error: function() {
                        $("#message").text("Error fetching status").css({
             "color": "white",
             "font-weight": "bold",
             "background-color": "Red", // or dark background for contrast
             "padding": "8px",
             "border-radius": "5px"
         });
          resetStatusForm();
                    }
                });
            } else {
                $("#statusSelect").val("");
                $("#message").text("");
            }
    }, 2000); // 2 seconds delay


        });

        // Save button click
        $("#saveStatusBtn").click(function () {
            var username = $("#usernameInput").val().trim();
            var status = $("#statusSelect").val();

            console.log( "hello ye mai use karha hu " + username +""+ status);
            if(!username){
                alert("Please enter username");
                return;
            }
            if(!status){
                alert("Please select status");
                return;
            }

            $.ajax({
                url: '@Url.Action("UpdateUserStatusCustomers", "Users")', // Update controller/action as needed
                type: 'POST',
                data: { username: username, status: status },
                success: function(response) {
                    console.log("yaha undefined araha hai " + response.status);
                    if(response.status || response.username)
                    {
                       $("#message").text("Status updated successfully")
         .css({
             "color": "white",
             "font-weight": "bold",
             "background-color": "green", // or dark background for contrast
             "padding": "8px",
             "border-radius": "5px"
         });

     $("table tbody tr").each(function () {
        var rowUsername = $(this).find("td:nth-child(7)").text().trim(); // Username column
        if (rowUsername.toLowerCase() === username.toLowerCase()) {
            $(this).find("td:nth-child(10)").text(status); // isActive column
        }
    });


         resetStatusForm();

                    } else {
                        $("#message").text("Failed to update status: " + response.message) .css({
             "color": "white",
             "font-weight": "bold",
             "background-color": "Red", // or dark background for contrast
             "padding": "8px",
             "border-radius": "5px"
         });

         resetStatusForm();
                     }
                },
                error: function() {
                    $("#message").text("Error updating status").css({
             "color": "white",
             "font-weight": "bold",
             "background-color": "Red", // or dark background for contrast
             "padding": "8px",
             "border-radius": "5px"
         });

         resetStatusForm();
                }
            });
        });

                function resetStatusForm() {
        setTimeout(function () {
            $("#usernameInput").val("").focus();
            $("#statusSelect").val("");
            $("#message").fadeOut(300, function () {
                $(this).text("").removeAttr("style").show();
            });
        }, 5000); // 2 seconds wait so user can read the message
    }

    });
</script>





